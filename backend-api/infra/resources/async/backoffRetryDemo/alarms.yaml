AWSTemplateFormatVersion: "2010-09-09"
Resources:
  AsyncBackoffRetryDemoInvalidSqsEventAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: DeployAlarms
    DependsOn:
      - "AsyncBackoffRetryDemoMetricFilter"
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Sub "arn:aws:sns:${AWS::Region}:${AWS::AccountId}:platform-alarms-sns-critical"
      OKActions:
        - !Sub "arn:aws:sns:${AWS::Region}:${AWS::AccountId}:platform-alarms-sns-critical"
      InsufficientDataActions: [ ]
      AlarmDescription: !Sub
        - "Fires when a log event with messageCode MOBILE_ASYNC_BACKOFF_RETRY_DEMO_INVALID_SQS_EVENT is detected. See support manual: ${SupportManualUrl}"
        - SupportManualUrl: !FindInMap
            - StaticVariables
            - SupportManual
            - value
      AlarmName: !Sub "${AWS::StackName}-backoff-retry-demo-lambda-invalid-sqs-event"
      Namespace: !Sub "${AWS::StackName}/LogMessages"
      MetricName: AsyncBackoffRetryDemoMessageCode
      Dimensions:
        - Name: MessageCode
          Value: MOBILE_ASYNC_BACKOFF_RETRY_DEMO_INVALID_SQS_EVENT
      Statistic: Sum
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  AsyncBackoffRetryDemoErrorRateAlarm:
    Condition: DeployAlarms
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: true
      AlarmDescription: "The number of Async Backoff Retry Demo Lambda errors is greater than or equal to 10% for the latest function version"
      AlarmName: !Sub "${AWS::StackName}-backoff-retry-demo-lambda-error-rate"
      AlarmActions:
        - !Sub "arn:aws:sns:${AWS::Region}:${AWS::AccountId}:platform-alarms-sns-warning"
      OKActions:
        - !Sub "arn:aws:sns:${AWS::Region}:${AWS::AccountId}:platform-alarms-sns-warning"
      ComparisonOperator: GreaterThanOrEqualToThreshold
      DatapointsToAlarm: 1
      EvaluationPeriods: 1
      TreatMissingData: notBreaching
      Threshold: 60
      Metrics:
        - Id: lambdaInvocations
          Label: "Sum of invocations for latest Lambda version"
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/Lambda
              MetricName: Invocations
              Dimensions:
                - Name: Resource
                  Value: !Sub "${AsyncBackoffRetryDemoFunction}:live"
                - Name: FunctionName
                  Value: !Ref AsyncBackoffRetryDemoFunction
                - Name: ExecutedVersion
                  Value: !GetAtt AsyncBackoffRetryDemoFunction.Version.Version
            Period: 60
            Stat: Sum
        - Id: lambdaErrors
          Label: "Sum of function errors for latest Lambda version"
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/Lambda
              MetricName: Errors
              Dimensions:
                - Name: Resource
                  Value: !Sub "${AsyncBackoffRetryDemoFunction}:live"
                - Name: FunctionName
                  Value: !Ref AsyncBackoffRetryDemoFunction
                - Name: ExecutedVersion
                  Value: !GetAtt AsyncBackoffRetryDemoFunction.Version.Version
            Period: 60
            Stat: Sum
        - Id: lambdaErrorPercentage
          Label: "Percentage of invocations that result in a function error"
          ReturnData: false
          Expression: (lambdaErrors/lambdaInvocations)*100
        - Id: lambdaErrorRate
          Label: "Error threshold calculation"
          ReturnData: true
          Expression: IF(lambdaErrors >= 10, lambdaErrorPercentage)

  AsyncBackoffRetryDemoLowCompletionAlarm:
    Condition: DeployAlarms
    Type: AWS::CloudWatch::Alarm
    DependsOn:
      - "AsyncBackoffRetryDemoCompletionMetricFilter"
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Sub "arn:aws:sns:${AWS::Region}:${AWS::AccountId}:platform-alarms-sns-warning"
      OKActions:
        - !Sub "arn:aws:sns:${AWS::Region}:${AWS::AccountId}:platform-alarms-sns-warning"
      InsufficientDataActions: [ ]
      AlarmDescription: "A large proportion of Async Backoff Retry Demo requests have not completed successfully."
      AlarmName: !Sub "${AWS::StackName}-backoff-retry-demo-lambda-low-completion"
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 80
      ComparisonOperator: LessThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: lambdaLogStarted
          Label: "Sum of MOBILE_ASYNC_BACKOFF_RETRY_DEMO_STARTED messageCodes for latest Lambda version"
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: !Sub "${AWS::StackName}/LogMessages"
              MetricName: AsyncBackoffRetryDemoMessageCode
              Dimensions:
                - Name: MessageCode
                  Value: MOBILE_ASYNC_BACKOFF_RETRY_DEMO_STARTED
                - Name: Version
                  Value: !GetAtt AsyncBackoffRetryDemoFunction.Version.Version
            Period: 60
            Stat: Sum
        - Id: lambdaLogCompleted
          Label: "Sum of MOBILE_ASYNC_BACKOFF_RETRY_DEMO_COMPLETED messageCodes for latest Lambda version"
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: !Sub "${AWS::StackName}/LogMessages"
              MetricName: AsyncBackoffRetryDemoMessageCode
              Dimensions:
                - Name: MessageCode
                  Value: MOBILE_ASYNC_BACKOFF_RETRY_DEMO_COMPLETED
                - Name: Version
                  Value: !GetAtt AsyncBackoffRetryDemoFunction.Version.Version
            Period: 60
            Stat: Sum
        - Id: lambdaLogCompletePercentage
          Label: "Percentage of invocations that complete successfully"
          ReturnData: false
          Expression: (lambdaLogCompleted/lambdaLogStarted)*100
        - Id: lowCompletionRateThreshold
          Label: "Error threshold calculation"
          ReturnData: true
          Expression: IF((lambdaLogStarted-lambdaLogCompleted)>= 5, lambdaLogCompletePercentage)
