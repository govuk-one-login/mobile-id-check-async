AWSTemplateFormatVersion: "2010-09-09"

Description: async-backend SAM template for the ID Check v2 app

Parameters:
  Environment:
    Description: The environment type
    Type: String
    AllowedValues:
      - dev
      - build
      - staging
    Default: dev

  CodeSigningConfigArn:
    Description: |
      The ARN of the Code Signing Config to use, provided by the deployment pipeline
    Type: String
    Default: none

  PermissionsBoundary:
    Description: |
      The ARN of the permissions boundary to apply to any role created by the template
    Type: String
    Default: none

  DevOverrideStsBaseUrl:
    Description: |
      Override the STS_BASE_URL value for development deployments
    Type: String
    Default: none

  DeployAlarmsInDev:
    Description: Set to `true` to deploy alarms in a dev environment
    Type: String
    Default: false

Mappings:
  StaticVariables:
    urls:
      WarningAlarmsRunbook: https://govukverify.atlassian.net/wiki/spaces/DCMAW/pages/4800446694/Alarms+Runbook+Warnings
      CriticalAlarmsRunbook: https://govukverify.atlassian.net/wiki/spaces/DCMAW/pages/4799594677/Alarms+Runbook+Alerts

  EnvironmentConfiguration:
    dev:
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables
    build:
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables
    staging:
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables
    integration:
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables
    production:
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceProductionVariables

  PrivateApigw:
    dev:
      ApiBurstLimit: 10
      ApiRateLimit: 10
    build:
      ApiBurstLimit: 10
      ApiRateLimit: 10
    staging:
      ApiBurstLimit: 0
      ApiRateLimit: 0
    integration:
      ApiBurstLimit: 0
      ApiRateLimit: 0
    production:
      ApiBurstLimit: 0
      ApiRateLimit: 0

  SessionsApigw:
    dev:
      ApiBurstLimit: 10
      ApiRateLimit: 10
    build:
      ApiBurstLimit: 10
      ApiRateLimit: 10
    staging:
      ApiBurstLimit: 0
      ApiRateLimit: 0
    integration:
      ApiBurstLimit: 0
      ApiRateLimit: 0
    production:
      ApiBurstLimit: 0
      ApiRateLimit: 0

  ProxyApigw:
    dev:
      ApiBurstLimit: 10
      ApiRateLimit: 10
    build:
      ApiBurstLimit: 10
      ApiRateLimit: 10
    staging:
      ApiBurstLimit: 0
      ApiRateLimit: 0
    integration:
      ApiBurstLimit: 0
      ApiRateLimit: 0
    production:
      ApiBurstLimit: 0
      ApiRateLimit: 0

  Lambda:
    dev:
      ReservedConcurrentExecutions: 15
      LogLevel: DEBUG
    build:
      ReservedConcurrentExecutions: 15
      LogLevel: INFO
    staging:
      ReservedConcurrentExecutions: 0
      LogLevel: INFO
    integration:
      ReservedConcurrentExecutions: 0
      LogLevel: INFO
    production:
      ReservedConcurrentExecutions: 0
      LogLevel: INFO

  TxMA:
    dev:
      TxmaAccount: arn:aws:iam::248098332657:root
    build:
      TxmaAccount: arn:aws:iam::750703655225:root
    staging:
      TxmaAccount: arn:aws:iam::178023842775:root
    integration:
      TxmaAccount: arn:aws:iam::729485541398:root
    production:
      TxmaAccount: arn:aws:iam::451773080033:root

  KMS:
    dev:
      PendingDeletionInDays: 7
    build:
      PendingDeletionInDays: 30
    staging:
      PendingDeletionInDays: 30
    integration:
      PendingDeletionInDays: 30
    production:
      PendingDeletionInDays: 30

  DNS:
    dev:
      BaseDns: review-b-async.dev.account.gov.uk
    build:
      BaseDns: review-b-async.build.account.gov.uk
    staging:
      BaseDns: review-b-async.staging.account.gov.uk
    integration:
      BaseDns: review-b-async.integration.account.gov.uk
    production:
      BaseDns: review-b-async.account.gov.uk

  EnvironmentVariables:
    dev:
      STSBASEURL: https://mob-sts-mock.review-b-async.dev.account.gov.uk
      BiometricSubmitterKeySecretPathPassport: /dev/BIOMETRIC_SUBMITTER_ACCESS_KEY_NFC_PASSPORT
      BiometricSubmitterKeySecretPathBrp: /dev/BIOMETRIC_SUBMITTER_ACCESS_KEY_NFC_BRP
      BiometricSubmitterKeySecretPathDl: /dev/BIOMETRIC_SUBMITTER_ACCESS_KEY_DL
      BiometricSubmitterKeySecretCacheDurationInSeconds: 900
    build:
      STSBASEURL: https://mob-sts-mock.review-b-async.build.account.gov.uk
      BiometricSubmitterKeySecretPathPassport: /build/BIOMETRIC_SUBMITTER_ACCESS_KEY_NFC_PASSPORT
      BiometricSubmitterKeySecretPathBrp: /build/BIOMETRIC_SUBMITTER_ACCESS_KEY_NFC_BRP
      BiometricSubmitterKeySecretPathDl: /build/BIOMETRIC_SUBMITTER_ACCESS_KEY_DL
      BiometricSubmitterKeySecretCacheDurationInSeconds: 900
    staging:
      STSBASEURL: "" #TODO: Update this value with 'real' STS URLs
      BiometricSubmitterKeySecretPathPassport: /staging/BIOMETRIC_SUBMITTER_ACCESS_KEY_NFC_PASSPORT
      BiometricSubmitterKeySecretPathBrp: /staging/BIOMETRIC_SUBMITTER_ACCESS_KEY_NFC_BRP
      BiometricSubmitterKeySecretPathDl: /staging/BIOMETRIC_SUBMITTER_ACCESS_KEY_DL
      BiometricSubmitterKeySecretCacheDurationInSeconds: 900
    integration:
      STSBASEURL: "" #TODO: Update this value with 'real' STS URLs
      BiometricSubmitterKeySecretPathPassport: /integration/BIOMETRIC_SUBMITTER_ACCESS_KEY_NFC_PASSPORT
      BiometricSubmitterKeySecretPathBrp: /integration/BIOMETRIC_SUBMITTER_ACCESS_KEY_NFC_BRP
      BiometricSubmitterKeySecretPathDl: /integration/BIOMETRIC_SUBMITTER_ACCESS_KEY_DL
      BiometricSubmitterKeySecretCacheDurationInSeconds: 900
    production:
      STSBASEURL: "" #TODO: Update this value with 'real' STS URLs
      BiometricSubmitterKeySecretPathPassport: /production/BIOMETRIC_SUBMITTER_ACCESS_KEY_NFC_PASSPORT
      BiometricSubmitterKeySecretPathBrp: /production/BIOMETRIC_SUBMITTER_ACCESS_KEY_NFC_BRP
      BiometricSubmitterKeySecretPathDl: /production/BIOMETRIC_SUBMITTER_ACCESS_KEY_DL
      BiometricSubmitterKeySecretCacheDurationInSeconds: 900

Conditions:
  UseCodeSigning: !Not
    - !Equals
      - !Ref CodeSigningConfigArn
      - none

  UsePermissionsBoundary: !Not
    - !Equals
      - !Ref PermissionsBoundary
      - none

  isNotDevOrBuild: !Or
    - !Equals
      - !Ref Environment
      - staging
    - !Equals
      - !Ref Environment
      - integration
    - !Equals
      - !Ref Environment
      - production

  IsDevOrBuild: !Or
    - !Equals
      - !Ref Environment
      - dev
    - !Equals
      - !Ref Environment
      - build

  ProxyApiDeployment: !Or
    - !Equals
      - !Ref Environment
      - dev
    - !Equals
      - !Ref Environment
      - build

  UseDevOverrideStsBaseUrl: !Not
    - !Equals
      - !Ref DevOverrideStsBaseUrl
      - none

  DeployAlarms: !Or
    - !Not
      - !Equals
        - !Ref Environment
        - dev
    - !Equals
      - !Ref DeployAlarmsInDev
      - true

Transform: AWS::Serverless-2016-10-31

Globals:
  Function:
    Timeout: 5
    MemorySize: 512
    ReservedConcurrentExecutions: !FindInMap
      - Lambda
      - !Ref Environment
      - ReservedConcurrentExecutions
    CodeSigningConfigArn: !If
      - UseCodeSigning
      - !Ref CodeSigningConfigArn
      - !Ref AWS::NoValue
    PermissionsBoundary: !If
      - UsePermissionsBoundary
      - !Ref PermissionsBoundary
      - !Ref AWS::NoValue
    LoggingConfig:
      ApplicationLogLevel: !FindInMap
        - Lambda
        - !Ref Environment
        - LogLevel
      SystemLogLevel: INFO
      LogFormat: JSON
    Architectures:
      - arm64
    Environment:
      Variables:
        SIGNING_KEY_ID: !GetAtt SecurityStack.Outputs.SigningKeyArn
        TXMA_SQS: !GetAtt SqsStack.Outputs.QueueUrl
        ISSUER: mockIssuer
        SESSION_TABLE_NAME: !GetAtt StorageStack.Outputs.TableName
        POWERTOOLS_SERVICE_NAME: mobile-id-check-async-backend
        AWS_LAMBDA_EXEC_WRAPPER: /opt/dynatrace
        DT_CONNECTION_AUTH_TOKEN: !Sub
          - '{{resolve:secretsmanager:${SecretArn}:SecretString:DT_CONNECTION_AUTH_TOKEN}}'
          - SecretArn: !FindInMap
              - EnvironmentConfiguration
              - !Ref Environment
              - dynatraceSecretArn
        DT_CONNECTION_BASE_URL: !Sub
          - '{{resolve:secretsmanager:${SecretArn}:SecretString:DT_CONNECTION_BASE_URL}}'
          - SecretArn: !FindInMap
              - EnvironmentConfiguration
              - !Ref Environment
              - dynatraceSecretArn
        DT_CLUSTER_ID: !Sub
          - '{{resolve:secretsmanager:${SecretArn}:SecretString:DT_CLUSTER_ID}}'
          - SecretArn: !FindInMap
              - EnvironmentConfiguration
              - !Ref Environment
              - dynatraceSecretArn
        DT_LOG_COLLECTION_AUTH_TOKEN: !Sub
          - '{{resolve:secretsmanager:${SecretArn}:SecretString:DT_LOG_COLLECTION_AUTH_TOKEN}}'
          - SecretArn: !FindInMap
              - EnvironmentConfiguration
              - !Ref Environment
              - dynatraceSecretArn
        DT_TENANT: !Sub
          - '{{resolve:secretsmanager:${SecretArn}:SecretString:DT_TENANT}}'
          - SecretArn: !FindInMap
              - EnvironmentConfiguration
              - !Ref Environment
              - dynatraceSecretArn
        DT_OPEN_TELEMETRY_ENABLE_INTEGRATION: "true"
    Layers:
      - !Sub
        - '{{resolve:secretsmanager:${SecretArn}:SecretString:NODEJS_LAYER}}'
        - SecretArn: !FindInMap
            - EnvironmentConfiguration
            - !Ref Environment
            - dynatraceSecretArn

Resources:

  # API Stacks
  PrivateApiStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: infra/api/private.yaml
      Parameters:
        Environment: !Ref Environment
        PermissionsBoundary: !Ref PermissionsBoundary
        StackName: !Ref AWS::StackName
        ApiBurstLimit: !FindInMap
          - PrivateApigw
          - !Ref Environment
          - ApiBurstLimit
        ApiRateLimit: !FindInMap
          - PrivateApigw
          - !Ref Environment
          - ApiRateLimit

  SessionsApiStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: infra/api/sessions.yaml
      Parameters:
        Environment: !Ref Environment
        PermissionsBoundary: !Ref PermissionsBoundary
        StackName: !Ref AWS::StackName
        ApiBurstLimit: !FindInMap
          - SessionsApigw
          - !Ref Environment
          - ApiBurstLimit
        ApiRateLimit: !FindInMap
          - SessionsApigw
          - !Ref Environment
          - ApiRateLimit
        BaseDns: !FindInMap
          - DNS
          - !Ref Environment
          - BaseDns

  ProxyApiStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: infra/api/proxy.yaml
      Parameters:
        Environment: !Ref Environment
        PermissionsBoundary: !Ref PermissionsBoundary
        StackName: !Ref AWS::StackName
        ApiBurstLimit: !FindInMap
          - ProxyApigw
          - !Ref Environment
          - ApiBurstLimit
        ApiRateLimit: !FindInMap
          - ProxyApigw
          - !Ref Environment
          - ApiRateLimit
        BaseDns: !FindInMap
          - DNS
          - !Ref Environment
          - BaseDns
    Condition: ProxyApiDeployment

  # Security Stacks
  SecurityStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: infra/security/kms.yaml
      Parameters:
        Environment: !Ref Environment
        StackName: !Ref AWS::StackName
        PendingDeletionInDays: !FindInMap
          - KMS
          - !Ref Environment
          - PendingDeletionInDays
        TxmaAccount: !FindInMap
          - TxMA
          - !Ref Environment
          - TxmaAccount

  # Storage Stacks
  StorageStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: infra/storage/session.yaml
      Parameters:
        Environment: !Ref Environment
        StackName: !Ref AWS::StackName

  S3Stack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: infra/storage/s3.yaml
      Parameters:
        Environment: !Ref Environment
        StackName: !Ref AWS::StackName

  SqsStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: infra/storage/sqs.yaml
      Parameters:
        Environment: !Ref Environment
        StackName: !Ref AWS::StackName
        TxmaAccount: !FindInMap
          - TxMA
          - !Ref Environment
          - TxmaAccount
        TxMAKmsKeyId: !GetAtt SecurityStack.Outputs.TxMAKmsKeyArn

  # Function Stacks
  TokenFunctionStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: infra/functions/token.yaml
      Parameters:
        Environment: !Ref Environment
        PermissionsBoundary: !Ref PermissionsBoundary
        StackName: !Ref AWS::StackName
        PrivateApiId: !GetAtt PrivateApiStack.Outputs.ApiId
        KmsSigningKeyArn: !GetAtt SecurityStack.Outputs.SigningKeyArn
        TxMAQueueArn: !GetAtt SqsStack.Outputs.QueueArn
        TxMAKmsKeyArn: !GetAtt SecurityStack.Outputs.TxMAKmsKeyArn

  CredentialFunctionStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: infra/functions/credential.yaml
      Parameters:
        Environment: !Ref Environment
        PermissionsBoundary: !Ref PermissionsBoundary
        StackName: !Ref AWS::StackName
        PrivateApiId: !GetAtt PrivateApiStack.Outputs.ApiId
        KmsSigningKeyArn: !GetAtt SecurityStack.Outputs.SigningKeyArn
        TxMAQueueArn: !GetAtt SqsStack.Outputs.QueueArn
        TxMAKmsKeyArn: !GetAtt SecurityStack.Outputs.TxMAKmsKeyArn
        SessionsTableArn: !GetAtt StorageStack.Outputs.TableArn
        SessionsTableName: !GetAtt StorageStack.Outputs.TableName

  ActiveSessionFunctionStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: infra/functions/activeSession.yaml
      Parameters:
        Environment: !Ref Environment
        PermissionsBoundary: !Ref PermissionsBoundary
        StackName: !Ref AWS::StackName
        SessionsTableArn: !GetAtt StorageStack.Outputs.TableArn
        KmsEncryptionKeyArn: !GetAtt SecurityStack.Outputs.EncryptionKeyArn
        StsBaseUrl: !If
          - UseDevOverrideStsBaseUrl
          - !Ref DevOverrideStsBaseUrl
          - !FindInMap
            - EnvironmentVariables
            - !Ref Environment
            - STSBASEURL
        SessionsApiDomainName: !GetAtt SessionsApiStack.Outputs.ApiUrl

  BiometricTokenFunctionStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: infra/functions/biometricToken.yaml
      Parameters:
        Environment: !Ref Environment
        PermissionsBoundary: !Ref PermissionsBoundary
        StackName: !Ref AWS::StackName

  JwksFunctionStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: infra/functions/jwks.yaml
      Parameters:
        Environment: !Ref Environment
        PermissionsBoundary: !Ref PermissionsBoundary
        StackName: !Ref AWS::StackName
        KmsEncryptionKeyArn: !GetAtt SecurityStack.Outputs.EncryptionKeyArn
        JwksBucketName: !GetAtt S3Stack.Outputs.BucketName

  ProxyFunctionStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: infra/functions/proxy.yaml
      Parameters:
        Environment: !Ref Environment
        PermissionsBoundary: !Ref PermissionsBoundary
        StackName: !Ref AWS::StackName
        PrivateApiUrl: !GetAtt PrivateApiStack.Outputs.ApiUrl
        ProxySecurityGroupId: !GetAtt ProxyApiStack.Outputs.SecurityGroupId
    Condition: ProxyApiDeployment

  # Monitoring Stack
  MonitoringStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: infra/monitoring/alarms.yaml
      Parameters:
        Environment: !Ref Environment
        StackName: !Ref AWS::StackName
    Condition: DeployAlarms

Outputs:
  SessionsApiUrl:
    Description: Sessions API Gateway base URL
    Value: !GetAtt SessionsApiStack.Outputs.ApiUrl

  ProxyApiUrl:
    Description: Proxy API Gateway Pretty DNS
    Value: !GetAtt ProxyApiStack.Outputs.ApiUrl
    Condition: ProxyApiDeployment

  PrivateApiUrl:
    Description: Private API Gateway base URL
    Value: !GetAtt PrivateApiStack.Outputs.ApiUrl

  StsMockApiUrl:
    Description: STS Mock API Gateway base URL
    Value: !If
      - UseDevOverrideStsBaseUrl
      - !Ref DevOverrideStsBaseUrl
      - !FindInMap
        - EnvironmentVariables
        - !Ref Environment
        - STSBASEURL

  TxmaSqsQueueArn:
    Description: TxMA SQS Queue ARN
    Value: !GetAtt SqsStack.Outputs.QueueArn
    Export:
      Name: !Sub ${AWS::StackName}-txma-sqs-queue-arn
    Condition: IsDevOrBuild

  TxmaKmsEncryptionKeyArn:
    Description: TxMA KMS Encryption Key ARN
    Value: !GetAtt SecurityStack.Outputs.TxMAKmsKeyArn
    Export:
      Name: !Sub ${AWS::StackName}-txma-kms-encryption-key-arn
    Condition: IsDevOrBuild
